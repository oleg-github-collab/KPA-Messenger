<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Kaminskyi AI Messenger</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="login.css">
</head>
<body>
  <!-- Language Selector -->
  <div class="language-switch">
    <label for="languageChoice">Language</label>
    <select id="languageChoice">
      <option value="en">English</option>
      <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
    </select>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Login Card -->
    <div class="login-card" id="loginCard">
      <div class="card-header">
        <h1 id="title">Kaminskyi AI Messenger</h1>
        <p id="subtitle">Secure video meetings and messaging</p>
      </div>

      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="username" id="usernameLabel">Username</label>
          <input id="username" name="username" type="text" required autofocus>
        </div>

        <div class="form-group">
          <label for="password" id="passwordLabel">Password</label>
          <input id="password" name="password" type="password" required>
        </div>

        <button type="submit" class="btn-primary" id="loginButton">Sign In</button>
      </form>

      <div id="loginError" class="error-message hidden"></div>
    </div>

    <!-- Dashboard Card -->
    <div class="dashboard-card hidden" id="dashboardCard">
      <div class="card-header">
        <div class="header-actions">
          <div></div>
          <button id="logoutBtn" class="btn-logout">Sign Out</button>
        </div>
        <div class="header-content">
          <h2 id="welcomeHeading">Welcome</h2>
          <p id="dashboardSubtitle">Create and join video meetings</p>
        </div>
      </div>

      <div class="media-settings">
        <h3>Media Settings</h3>
        <div class="media-options">
          <label class="media-option">
            <input type="checkbox" id="enableVideo" checked>
            <span class="checkbox-mark"></span>
            <span class="option-text">Camera</span>
            <span class="option-icon">üìπ</span>
          </label>

          <label class="media-option">
            <input type="checkbox" id="enableAudio" checked>
            <span class="checkbox-mark"></span>
            <span class="option-text">Microphone</span>
            <span class="option-icon">üé§</span>
          </label>
        </div>
      </div>

      <div class="meeting-controls">
        <button id="createMeetingBtn" class="btn-primary">Create Meeting</button>
        <button id="createInvoiceMeetingBtn" class="btn-secondary">Create Meeting + Invoice</button>

        <div class="capacity-control">
          <label for="maxParticipants" id="capacityLabel">Max Participants</label>
          <input type="range" id="maxParticipants" min="2" max="20" value="20">
          <span class="capacity-value" id="capacityValue">20 participants</span>
        </div>
      </div>

      <div id="meetingBlock" class="meeting-result hidden">
        <h3 id="meetingReadyHeading">Meeting Ready!</h3>
        <p id="meetingReadyText">Share this link to invite participants</p>

        <div class="link-container">
          <input id="meetingLink" class="meeting-link" readonly>
          <button id="copyMeetingBtn" class="btn-copy">Copy</button>
        </div>

        <div class="meeting-actions">
          <button id="openMeetingBtn" class="btn-primary">Join Meeting</button>
        </div>

        <div id="meetingMessage" class="status-message"></div>
      </div>

      <!-- Invoice Creation Modal -->
      <div id="invoiceModal" class="modal hidden">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Create Meeting with Invoice</h3>
            <button class="modal-close" id="invoiceModalClose">√ó</button>
          </div>

          <form id="invoiceForm" class="invoice-form">
            <div class="form-section">
              <h4>Client Information</h4>
              <div class="form-group">
                <label for="clientEmail">Client Email *</label>
                <input type="email" id="clientEmail" required>
              </div>
              <div class="form-group">
                <label for="clientName">Client Name</label>
                <input type="text" id="clientName">
              </div>
            </div>

            <div class="form-section">
              <h4>Service Details</h4>
              <div class="form-group">
                <label for="serviceTemplate">Service Template</label>
                <select id="serviceTemplate">
                  <option value="custom">Custom</option>
                  <option value="consultation">Video Consultation</option>
                  <option value="meeting">Business Meeting</option>
                  <option value="training">Training Session</option>
                </select>
              </div>
              <div class="form-group">
                <label for="serviceDescription">Description *</label>
                <input type="text" id="serviceDescription" required placeholder="e.g., 1-hour consultation">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="serviceAmount">Amount *</label>
                  <input type="number" id="serviceAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                  <label for="serviceCurrency">Currency</label>
                  <select id="serviceCurrency">
                    <option value="usd">USD</option>
                    <option value="eur">EUR</option>
                    <option value="uah">UAH</option>
                    <option value="gbp">GBP</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label for="dueDate">Payment Due Date</label>
                <input type="date" id="dueDate">
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" id="cancelInvoice">Cancel</button>
              <button type="submit" class="btn-primary">Create Meeting & Send Invoice</button>
            </div>
          </form>

          <div id="invoiceError" class="error-message hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const translations = {
      en: {
        title: 'Kaminskyi AI Messenger',
        subtitle: 'Secure video meetings and messaging',
        usernameLabel: 'Username',
        passwordLabel: 'Password',
        loginButton: 'Sign In',
        welcomeHeading: (user) => `Welcome, ${user}`,
        dashboardSubtitle: 'Create and join video meetings',
        logout: 'Sign Out',
        createMeeting: 'Create Meeting',
        capacityLabel: 'Max Participants',
        capacityValue: (count) => `${count} participants`,
        creating: 'Creating...',
        meetingReadyHeading: 'Meeting Ready!',
        meetingReadyText: 'Share this link to invite participants',
        copy: 'Copy',
        openMeeting: 'Join Meeting',
        linkCopied: 'Link copied to clipboard!',
        linkCopyError: 'Could not copy link',
        sessionExpired: 'Session expired. Please sign in again.',
        authError: 'Invalid username or password',
        meetingError: 'Failed to create meeting'
      },
      uk: {
        title: '–ö–∞–º—ñ–Ω—Å—å–∫–∏–π AI –ú–µ—Å–µ–Ω–¥–∂–µ—Ä',
        subtitle: '–ó–∞—Ö–∏—â–µ–Ω—ñ –≤—ñ–¥–µ–æ–∑—É—Å—Ç—Ä—ñ—á—ñ —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
        usernameLabel: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á',
        passwordLabel: '–ü–∞—Ä–æ–ª—å',
        loginButton: '–£–≤—ñ–π—Ç–∏',
        welcomeHeading: (user) => `–í—ñ—Ç–∞—î–º–æ, ${user}`,
        dashboardSubtitle: '–°—Ç–≤–æ—Ä—é–π—Ç–µ —Ç–∞ –ø—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ –≤—ñ–¥–µ–æ–∑—É—Å—Ç—Ä—ñ—á–µ–π',
        logout: '–í–∏–π—Ç–∏',
        createMeeting: '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑—É—Å—Ç—Ä—ñ—á',
        capacityLabel: '–ú–∞–∫—Å. —É—á–∞—Å–Ω–∏–∫—ñ–≤',
        capacityValue: (count) => `${count} —É—á–∞—Å–Ω–∏–∫—ñ–≤`,
        creating: '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è...',
        meetingReadyHeading: '–ó—É—Å—Ç—Ä—ñ—á –≥–æ—Ç–æ–≤–∞!',
        meetingReadyText: '–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Ü–∏–º –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º —â–æ–± –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ —É—á–∞—Å–Ω–∏–∫—ñ–≤',
        copy: '–ö–æ–ø—ñ—é–≤–∞—Ç–∏',
        openMeeting: '–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è',
        linkCopied: '–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!',
        linkCopyError: '–ù–µ –≤–¥–∞–ª–æ—Å—å —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è',
        sessionExpired: '–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å. –£–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.',
        authError: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å',
        meetingError: '–ù–µ –≤–¥–∞–ª–æ—Å—å —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑—É—Å—Ç—Ä—ñ—á'
      }
    };

    // DOM Elements
    const loginForm = document.getElementById('loginForm');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const welcomeHeading = document.getElementById('welcomeHeading');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const createMeetingBtn = document.getElementById('createMeetingBtn');
    const meetingBlock = document.getElementById('meetingBlock');
    const meetingLinkInput = document.getElementById('meetingLink');
    const copyMeetingBtn = document.getElementById('copyMeetingBtn');
    const openMeetingBtn = document.getElementById('openMeetingBtn');
    const meetingMessage = document.getElementById('meetingMessage');
    const maxParticipantsInput = document.getElementById('maxParticipants');
    const capacityValue = document.getElementById('capacityValue');
    const langSelect = document.getElementById('languageChoice');

    // Language Management
    let currentLang = localStorage.getItem('kaminskyi-lang') || 'en';
    if (!translations[currentLang]) currentLang = 'en';
    langSelect.value = currentLang;

    function t(key, ...args) {
      const value = translations[currentLang][key];
      return typeof value === 'function' ? value(...args) : value;
    }

    function updateCapacityDisplay() {
      capacityValue.textContent = t('capacityValue', parseInt(maxParticipantsInput.value));
    }

    function applyTranslations() {
      document.documentElement.lang = currentLang;
      document.title = t('title');
      document.getElementById('title').textContent = t('title');
      document.getElementById('subtitle').textContent = t('subtitle');
      document.getElementById('usernameLabel').textContent = t('usernameLabel');
      document.getElementById('passwordLabel').textContent = t('passwordLabel');
      document.getElementById('loginButton').textContent = t('loginButton');
      document.getElementById('dashboardSubtitle').textContent = t('dashboardSubtitle');
      logoutBtn.textContent = t('logout');
      createMeetingBtn.textContent = t('createMeeting');
      document.getElementById('capacityLabel').textContent = t('capacityLabel');
      updateCapacityDisplay();
      document.getElementById('meetingReadyHeading').textContent = t('meetingReadyHeading');
      document.getElementById('meetingReadyText').textContent = t('meetingReadyText');
      copyMeetingBtn.textContent = t('copy');
      openMeetingBtn.textContent = t('openMeeting');
    }

    function setLanguage(lang) {
      if (!translations[lang]) return;
      currentLang = lang;
      localStorage.setItem('kaminskyi-lang', lang);
      applyTranslations();
    }

    langSelect.addEventListener('change', (e) => {
      setLanguage(e.target.value);
      const username = sessionStorage.getItem('username');
      if (username) {
        welcomeHeading.textContent = t('welcomeHeading', username);
      }
    });

    // Authentication
    function showError(message) {
      loginError.textContent = message;
      loginError.classList.remove('hidden');
      setTimeout(() => loginError.classList.add('hidden'), 5000);
    }

    function showDashboard() {
      const username = sessionStorage.getItem('username');
      if (!username) return;

      welcomeHeading.textContent = t('welcomeHeading', username);
      loginCard.classList.add('hidden');
      dashboardCard.classList.remove('hidden');
      meetingBlock.classList.add('hidden');
      meetingMessage.textContent = '';
    }

    function showLogin() {
      sessionStorage.removeItem('authToken');
      sessionStorage.removeItem('username');
      loginCard.classList.remove('hidden');
      dashboardCard.classList.add('hidden');
      loginForm.reset();
    }

    async function handleLogin(event) {
      event.preventDefault();
      loginError.classList.add('hidden');

      const formData = new FormData(loginForm);
      const credentials = {
        username: formData.get('username').trim(),
        password: formData.get('password')
      };

      if (!credentials.username || !credentials.password) {
        showError('Please fill in all fields');
        return;
      }

      const submitBtn = document.getElementById('loginButton');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Signing in...';

      try {
        const response = await fetch('/auth', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(credentials)
        });

        const data = await response.json();

        if (response.ok && data.ok) {
          sessionStorage.setItem('authToken', data.token);
          sessionStorage.setItem('username', data.username);
          showDashboard();
        } else {
          throw new Error(data.message || t('authError'));
        }
      } catch (error) {
        console.error('Login error:', error);
        showError(error.message || t('authError'));
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = t('loginButton');
      }
    }

    // Meeting Management
    async function createMeeting() {
      const token = sessionStorage.getItem('authToken');
      if (!token) {
        showError(t('sessionExpired'));
        showLogin();
        return;
      }

      createMeetingBtn.disabled = true;
      createMeetingBtn.textContent = t('creating');
      meetingMessage.textContent = '';

      try {
        const response = await fetch('/api/meetings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            maxParticipants: parseInt(maxParticipantsInput.value)
          })
        });

        const data = await response.json();

        if (response.ok && data.ok) {
          // Use the meeting URL provided by the server (mobile.html or desktop.html)
          meetingLinkInput.value = data.meetingUrl;
          openMeetingBtn.dataset.roomToken = data.token;
          meetingBlock.classList.remove('hidden');
          meetingMessage.textContent = `Ready for ${t('capacityValue', data.maxParticipants || 20)}`;
        } else {
          throw new Error(data.message || t('meetingError'));
        }
      } catch (error) {
        console.error('Meeting creation error:', error);
        meetingMessage.textContent = error.message || t('meetingError');
        meetingBlock.classList.remove('hidden');
      } finally {
        createMeetingBtn.disabled = false;
        createMeetingBtn.textContent = t('createMeeting');
      }
    }

    function copyMeetingLink() {
      const link = meetingLinkInput.value;
      if (!link) return;

      if (navigator.clipboard) {
        navigator.clipboard.writeText(link)
          .then(() => meetingMessage.textContent = t('linkCopied'))
          .catch(() => meetingMessage.textContent = t('linkCopyError'));
      } else {
        // Fallback for older browsers
        meetingLinkInput.select();
        try {
          document.execCommand('copy');
          meetingMessage.textContent = t('linkCopied');
        } catch {
          meetingMessage.textContent = t('linkCopyError');
        }
      }
    }

    function openMeeting() {
      const token = openMeetingBtn.dataset.roomToken;
      if (!token) return;

      // Store media preferences
      const enableVideo = document.getElementById('enableVideo').checked;
      const enableAudio = document.getElementById('enableAudio').checked;

      sessionStorage.setItem('enableVideo', enableVideo.toString());
      sessionStorage.setItem('enableAudio', enableAudio.toString());

      // Store current meeting token for cleanup later
      sessionStorage.setItem('currentMeetingToken', token);

      // Detect device and navigate to appropriate page
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
      const targetPage = isMobile ? '/mobile.html' : '/desktop.html';
      window.location.href = `${targetPage}?room=${encodeURIComponent(token)}`;
    }

    async function endCurrentMeeting() {
      const currentToken = openMeetingBtn.dataset.roomToken;
      if (!currentToken) return;

      try {
        const token = sessionStorage.getItem('authToken');
        const response = await fetch(`/api/meetings/${currentToken}/end`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          console.log('Meeting ended successfully');
        }
      } catch (error) {
        console.error('Error ending meeting:', error);
      }

      // Clear current meeting data
      openMeetingBtn.dataset.roomToken = '';
      meetingBlock.classList.add('hidden');
      meetingLinkInput.value = '';
      meetingMessage.textContent = '';
    }

    // Event Listeners
    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', showLogin);
    createMeetingBtn.addEventListener('click', createMeeting);
    copyMeetingBtn.addEventListener('click', copyMeetingLink);
    openMeetingBtn.addEventListener('click', openMeeting);
    maxParticipantsInput.addEventListener('input', updateCapacityDisplay);

    // Invoice modal event listeners
    const createInvoiceMeetingBtn = document.getElementById('createInvoiceMeetingBtn');
    const invoiceModal = document.getElementById('invoiceModal');
    const invoiceModalClose = document.getElementById('invoiceModalClose');
    const invoiceForm = document.getElementById('invoiceForm');
    const cancelInvoice = document.getElementById('cancelInvoice');
    const serviceTemplate = document.getElementById('serviceTemplate');
    const invoiceError = document.getElementById('invoiceError');

    createInvoiceMeetingBtn.addEventListener('click', openInvoiceModal);
    invoiceModalClose.addEventListener('click', closeInvoiceModal);
    cancelInvoice.addEventListener('click', closeInvoiceModal);
    invoiceForm.addEventListener('submit', handleInvoiceCreation);
    serviceTemplate.addEventListener('change', handleTemplateChange);

    // Invoice Modal Functions
    function openInvoiceModal() {
      invoiceModal.classList.remove('hidden');
      // Set default due date to 30 days from now
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 30);
      document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
    }

    function closeInvoiceModal() {
      invoiceModal.classList.add('hidden');
      invoiceForm.reset();
      invoiceError.classList.add('hidden');
    }

    function handleTemplateChange() {
      const template = serviceTemplate.value;
      const descriptionField = document.getElementById('serviceDescription');
      const amountField = document.getElementById('serviceAmount');

      const templates = {
        consultation: { description: '1-hour video consultation', amount: 100 },
        meeting: { description: 'Business meeting session', amount: 75 },
        training: { description: 'Training session', amount: 150 }
      };

      if (templates[template]) {
        descriptionField.value = templates[template].description;
        amountField.value = templates[template].amount;
      } else if (template === 'custom') {
        descriptionField.value = '';
        amountField.value = '';
      }
    }

    async function handleInvoiceCreation(event) {
      event.preventDefault();
      invoiceError.classList.add('hidden');

      const invoiceData = {
        maxParticipants: parseInt(maxParticipantsInput.value),
        hostName: sessionStorage.getItem('username'),
        clientEmail: document.getElementById('clientEmail').value,
        clientName: document.getElementById('clientName').value,
        amount: parseFloat(document.getElementById('serviceAmount').value),
        currency: document.getElementById('serviceCurrency').value,
        description: document.getElementById('serviceDescription').value,
        dueDate: document.getElementById('dueDate').value,
        template: document.getElementById('serviceTemplate').value
      };

      if (!invoiceData.clientEmail || !invoiceData.amount || !invoiceData.description) {
        showInvoiceError('Please fill in all required fields');
        return;
      }

      const submitBtn = invoiceForm.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      try {
        const response = await fetch('/api/meetings/with-invoice', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionStorage.getItem('authToken')}`,
            'Accept': 'application/json'
          },
          body: JSON.stringify(invoiceData)
        });

        const data = await response.json();

        if (response.ok && data.ok) {
          // Close modal and show success
          closeInvoiceModal();

          // Use the meeting URL provided by the server
          meetingLinkInput.value = data.meetingUrl;
          openMeetingBtn.dataset.roomToken = data.token;
          meetingBlock.classList.remove('hidden');

          meetingMessage.innerHTML = `
            <div style="color: green; margin-bottom: 10px;">
              ‚úÖ Meeting created and invoice sent to ${invoiceData.clientEmail}
            </div>
            <div>
              <strong>Invoice:</strong> ${data.invoice.currency.toUpperCase()} ${(data.invoice.amount_due / 100).toFixed(2)}
            </div>
            <div>
              <a href="${data.invoice.url}" target="_blank" style="color: #4f46e5;">View Invoice</a>
            </div>
          `;
        } else {
          throw new Error(data.message || 'Failed to create meeting with invoice');
        }
      } catch (error) {
        console.error('Invoice creation error:', error);
        showInvoiceError(error.message || 'Failed to create meeting with invoice');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Meeting & Send Invoice';
      }
    }

    function showInvoiceError(message) {
      invoiceError.textContent = message;
      invoiceError.classList.remove('hidden');
    }

    // Initialize
    function init() {
      applyTranslations();

      // Check if user is returning from a meeting
      const currentMeetingToken = sessionStorage.getItem('currentMeetingToken');
      if (currentMeetingToken) {
        // User returned from meeting, clean up
        endCurrentMeeting().then(() => {
          sessionStorage.removeItem('currentMeetingToken');
        });
      }

      // Check existing session
      const token = sessionStorage.getItem('authToken');
      const username = sessionStorage.getItem('username');

      if (token && username) {
        showDashboard();
      } else {
        showLogin();
      }
    }

    // Start app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kaminskyi AI Messenger</title>
  <link rel="stylesheet" href="login.css">
</head>
<body class="auth-body">
  <div class="language-switch floating" id="languageSelector">
    <label for="languageChoice">Language / Мова</label>
    <select id="languageChoice">
      <option value="en">English</option>
      <option value="uk">Українська</option>
    </select>
  </div>

  <main class="auth-container">
    <section class="card" id="loginCard">
      <h1 id="title"></h1>
      <p class="muted" id="subtitle"></p>
      <form id="loginForm" class="stack-form" autocomplete="off">
        <label for="username" id="usernameLabel"></label>
        <input id="username" name="username" required placeholder="Oleh" autofocus>

        <label for="password" id="passwordLabel"></label>
        <input id="password" name="password" type="password" required placeholder="••••••">

        <button type="submit" class="primary" id="loginButton"></button>
      </form>
      <div id="loginError" class="error hidden"></div>
    </section>

    <section class="card hidden" id="dashboardCard">
      <header class="card-header">
        <div>
          <h2 id="welcomeHeading"></h2>
          <p class="muted" id="dashboardSubtitle"></p>
        </div>
        <button id="logoutBtn" class="ghost"></button>
      </header>

      <div class="card-body">
        <button id="createMeetingBtn" class="primary full-width"></button>

        <div class="meeting-options" id="meetingOptions">
          <label for="maxParticipants" id="capacityLabel"></label>
          <input type="range" id="maxParticipants" min="2" max="10" value="10">
          <div class="range-value" id="capacityValue"></div>
        </div>

        <div id="meetingBlock" class="meeting-block hidden">
          <h3 id="meetingReadyHeading"></h3>
          <p class="muted" id="meetingReadyText"></p>
          <div class="link-row">
            <input id="meetingLink" readonly>
            <button id="copyMeetingBtn" class="ghost"></button>
          </div>
          <div class="actions-row">
            <button id="openMeetingBtn" class="primary"></button>
          </div>
          <div id="meetingMessage" class="muted"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const translations = {
      en: {
        title: 'Kaminskyi AI Messenger',
        subtitle: 'Sign in with your secure credentials to host a meeting.',
        usernameLabel: 'Username',
        passwordLabel: 'Password',
        loginButton: 'Log In',
        welcomeHeading: (user) => `Signed in as ${user}`,
        dashboardSubtitle: 'Generate one-time meeting links and share them instantly.',
        logout: 'Log out',
        createMeeting: 'Create one-time meeting',
        capacityLabel: 'Meeting capacity',
        capacityValue: (count) => `${count} participants`,
        creating: 'Creating…',
        meetingReadyHeading: 'Your meeting is ready',
        meetingReadyText: 'Share this link with a participant. It stops working when the host ends the call.',
        copy: 'Copy',
        openMeeting: 'Open meeting',
        linkReady: 'Send this one-time link to your participant.',
        linkCopied: 'Link copied to clipboard!',
        linkCopyError: 'Unable to copy automatically. Copy it manually.',
        sessionExpired: 'Session expired. Please log in again.',
        authError: 'Failed to authenticate.',
        meetingError: 'Unable to create meeting.',
        languageLabel: 'Language',
      },
      uk: {
        title: 'Камінський AI Месенджер',
        subtitle: 'Увійдіть за захищеними обліковими даними, щоб організувати зустріч.',
        usernameLabel: 'Ім’я користувача',
        passwordLabel: 'Пароль',
        loginButton: 'Увійти',
        welcomeHeading: (user) => `Увійшли як ${user}`,
        dashboardSubtitle: 'Створюйте одноразові посилання на зустріч і миттєво діліться ними.',
        logout: 'Вийти',
        createMeeting: 'Створити одноразову зустріч',
        creating: 'Створення…',
        meetingReadyHeading: 'Зустріч готова',
        meetingReadyText: 'Надішліть посилання учаснику. Воно перестає працювати після завершення зустрічі хостом.',
        copy: 'Скопіювати',
        capacityLabel: 'Місткість зустрічі',
        capacityValue: (count) => `${count} учасників`,
        openMeeting: 'Відкрити зустріч',
        linkReady: 'Надішліть це одноразове посилання учаснику.',
        linkCopied: 'Посилання скопійовано!',
        linkCopyError: 'Не вдалося скопіювати автоматично. Скопіюйте вручну.',
        sessionExpired: 'Сеанс завершено. Увійдіть ще раз.',
        authError: 'Не вдалося авторизуватися.',
        meetingError: 'Не вдалося створити зустріч.',
        languageLabel: 'Мова',
      },
    };

    const loginForm = document.getElementById('loginForm');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const welcomeHeading = document.getElementById('welcomeHeading');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const createMeetingBtn = document.getElementById('createMeetingBtn');
    const meetingBlock = document.getElementById('meetingBlock');
    const meetingLinkInput = document.getElementById('meetingLink');
    const copyMeetingBtn = document.getElementById('copyMeetingBtn');
    const openMeetingBtn = document.getElementById('openMeetingBtn');
    const meetingMessage = document.getElementById('meetingMessage');
    const maxParticipantsInput = document.getElementById('maxParticipants');
    const capacityLabel = document.getElementById('capacityLabel');
    const capacityValue = document.getElementById('capacityValue');
    const langSelect = document.getElementById('languageChoice');
    const langLabel = document.querySelector("label[for='languageChoice']");

    let currentLang = localStorage.getItem('kaminskyi-lang') || 'en';
    if (!translations[currentLang]) currentLang = 'en';
    langSelect.value = currentLang;

    function t(key, ...args) {
      const value = translations[currentLang][key];
      return typeof value === 'function' ? value(...args) : value;
    }

    function updateCapacityDisplay() {
      const value = Number(maxParticipantsInput.value);
      capacityValue.textContent = translations[currentLang].capacityValue(value);
    }

    function applyStaticText() {
      document.documentElement.lang = currentLang;
      document.title = t('title');
      document.getElementById('title').textContent = t('title');
      document.getElementById('subtitle').textContent = t('subtitle');
      document.getElementById('usernameLabel').textContent = t('usernameLabel');
      document.getElementById('passwordLabel').textContent = t('passwordLabel');
      document.getElementById('loginButton').textContent = t('loginButton');
      document.getElementById('dashboardSubtitle').textContent = t('dashboardSubtitle');
      logoutBtn.textContent = t('logout');
      createMeetingBtn.textContent = t('createMeeting');
      capacityLabel.textContent = t('capacityLabel');
      updateCapacityDisplay();
      document.getElementById('meetingReadyHeading').textContent = t('meetingReadyHeading');
      document.getElementById('meetingReadyText').textContent = t('meetingReadyText');
      copyMeetingBtn.textContent = t('copy');
      openMeetingBtn.textContent = t('openMeeting');
      langLabel.textContent = `${t('languageLabel')} / Language`;
    }

    function setLanguage(lang) {
      if (!translations[lang]) return;
      currentLang = lang;
      localStorage.setItem('kaminskyi-lang', lang);
      applyStaticText();
    }

    langSelect.addEventListener('change', (event) => {
      setLanguage(event.target.value);
      if (sessionStorage.getItem('username')) {
        welcomeHeading.textContent = t('welcomeHeading', sessionStorage.getItem('username'));
      }
    });

    function setAuthState(username, token) {
      if (username && token) {
        sessionStorage.setItem('authToken', token);
        sessionStorage.setItem('username', username);
        showDashboard();
      } else {
        sessionStorage.removeItem('authToken');
        sessionStorage.removeItem('username');
        meetingBlock.classList.add('hidden');
        loginCard.classList.remove('hidden');
        dashboardCard.classList.add('hidden');
        loginForm.reset();
        if (username) {
          document.getElementById('username').value = username;
        }
      }
    }

    function showDashboard() {
      const username = sessionStorage.getItem('username');
      if (!username) return;
      welcomeHeading.textContent = t('welcomeHeading', username);
      loginCard.classList.add('hidden');
      dashboardCard.classList.remove('hidden');
      loginError.classList.add('hidden');
      meetingBlock.classList.add('hidden');
      meetingMessage.textContent = '';
    }

    async function handleLogin(event) {
      event.preventDefault();
      loginError.classList.add('hidden');
      const formData = new FormData(loginForm);
      const payload = {
        username: formData.get('username'),
        password: formData.get('password'),
      };

      try {
        const response = await fetch('/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.message || t('authError'));
        }

        setAuthState(data.username, data.token);
      } catch (error) {
        loginError.textContent = error.message || t('authError');
        loginError.classList.remove('hidden');
      }
    }

    async function createMeeting() {
      const token = sessionStorage.getItem('authToken');
      if (!token) {
        loginError.textContent = t('sessionExpired');
        loginError.classList.remove('hidden');
        setAuthState();
        return;
      }

      createMeetingBtn.disabled = true;
      createMeetingBtn.textContent = t('creating');
      meetingMessage.textContent = '';

      try {
        const capacity = Number(maxParticipantsInput.value);
        const response = await fetch('/api/meetings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ maxParticipants: capacity }),
        });

        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.message || t('meetingError'));
        }

        meetingLinkInput.value = data.meetingUrl;
        meetingBlock.classList.remove('hidden');
        meetingMessage.textContent = `${t('linkReady')} ${translations[currentLang].capacityValue(capacity)}`;
        openMeetingBtn.dataset.roomToken = data.token;
      } catch (error) {
        meetingMessage.textContent = error.message || t('meetingError');
        meetingBlock.classList.remove('hidden');
      } finally {
        createMeetingBtn.disabled = false;
        createMeetingBtn.textContent = t('createMeeting');
      }
    }

    function copyMeetingLink() {
      const link = meetingLinkInput.value;
      if (!link) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(link)
          .then(() => {
            meetingMessage.textContent = t('linkCopied');
          })
          .catch(() => {
            meetingMessage.textContent = t('linkCopyError');
          });
      } else {
        meetingMessage.textContent = t('linkCopyError');
      }
    }

    function openMeeting() {
      const token = openMeetingBtn.dataset.roomToken;
      if (!token) return;
      window.location.href = `/chat.html?room=${encodeURIComponent(token)}`;
    }

    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', () => {
      setAuthState();
    });
    createMeetingBtn.addEventListener('click', createMeeting);
    copyMeetingBtn.addEventListener('click', copyMeetingLink);
    openMeetingBtn.addEventListener('click', openMeeting);
    maxParticipantsInput.addEventListener('input', updateCapacityDisplay);

    (function bootstrap() {
      applyStaticText();
      const token = sessionStorage.getItem('authToken');
      const username = sessionStorage.getItem('username');
      if (token && username) {
        showDashboard();
      }
    })();
  </script>
</body>
</html>

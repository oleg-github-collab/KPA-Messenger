<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Kaminskyi AI Messenger · Камінський AI Месенджер</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="auth-body">
  <main class="auth-container">
    <section class="card" id="loginCard">
      <h1>Kaminskyi AI Messenger · Камінський AI Месенджер</h1>
      <p class="muted">Sign in with the configured credentials to host a meeting. / Увійдіть за попередньо заданими даними, щоб створити зустріч.</p>
      <form id="loginForm" class="stack-form" autocomplete="off">
        <label for="username">Username / Ім’я користувача</label>
        <input id="username" name="username" required placeholder="Oleh" autofocus>

        <label for="password">Password / Пароль</label>
        <input id="password" name="password" type="password" required placeholder="••••••">

        <button type="submit" class="primary">Log In / Увійти</button>
      </form>
      <div id="loginError" class="error hidden"></div>
    </section>

    <section class="card hidden" id="dashboardCard">
      <header class="card-header">
        <div>
          <h2 id="welcomeHeading"></h2>
          <p class="muted">Generate one-time meeting links and share them like Google Meet. / Створюйте одноразові посилання і діліться ними, як у Google Meet.</p>
        </div>
        <button id="logoutBtn" class="ghost">Log out / Вийти</button>
      </header>

      <div class="card-body">
        <button id="createMeetingBtn" class="primary full-width">Create one-time meeting / Створити одноразову зустріч</button>

        <div id="meetingBlock" class="meeting-block hidden">
          <h3>Your meeting is ready / Зустріч готова</h3>
          <p class="muted">Share this link with a participant. It stops working after the host ends the call. / Надішліть посилання учаснику. Воно перестає працювати після завершення зустрічі.</p>
          <div class="link-row">
            <input id="meetingLink" readonly>
            <button id="copyMeetingBtn" class="ghost">Copy / Скопіювати</button>
          </div>
          <div class="actions-row">
            <button id="openMeetingBtn" class="primary">Open meeting / Відкрити зустріч</button>
          </div>
          <div id="meetingMessage" class="muted"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const TEXT = {
      loginHeading: 'Logged in as / Ви ввійшли як',
      creating: 'Creating… / Створення…',
      create: 'Create one-time meeting / Створити одноразову зустріч',
      authError: 'Failed to authenticate. / Не вдалося авторизуватися.',
      sessionExpired: 'Session expired. Please log in again. / Сеанс завершено. Увійдіть ще раз.',
      linkReady: 'Send this one-time link to your participant. / Надішліть це одноразове посилання учаснику.',
      linkCopied: 'Link copied to clipboard! / Посилання скопійовано!',
      linkCopyError: 'Unable to copy automatically. Copy it manually. / Не вдалося скопіювати автоматично. Скопіюйте вручну.',
      meetingError: 'Unable to create meeting. / Не вдалося створити зустріч.'
    };

    const loginForm = document.getElementById('loginForm');
    const loginCard = document.getElementById('loginCard');
    const dashboardCard = document.getElementById('dashboardCard');
    const welcomeHeading = document.getElementById('welcomeHeading');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const createMeetingBtn = document.getElementById('createMeetingBtn');
    const meetingBlock = document.getElementById('meetingBlock');
    const meetingLinkInput = document.getElementById('meetingLink');
    const copyMeetingBtn = document.getElementById('copyMeetingBtn');
    const openMeetingBtn = document.getElementById('openMeetingBtn');
    const meetingMessage = document.getElementById('meetingMessage');

    function setAuthState(username, token) {
      if (username && token) {
        sessionStorage.setItem('authToken', token);
        sessionStorage.setItem('username', username);
        showDashboard();
      } else {
        sessionStorage.removeItem('authToken');
        sessionStorage.removeItem('username');
        meetingBlock.classList.add('hidden');
        loginCard.classList.remove('hidden');
        dashboardCard.classList.add('hidden');
        loginForm.reset();
        if (username) {
          document.getElementById('username').value = username;
        }
      }
    }

    function showDashboard() {
      const username = sessionStorage.getItem('username');
      if (!username) return;
      welcomeHeading.textContent = `${TEXT.loginHeading} ${username}`;
      loginCard.classList.add('hidden');
      dashboardCard.classList.remove('hidden');
      loginError.classList.add('hidden');
      meetingBlock.classList.add('hidden');
      meetingMessage.textContent = '';
    }

    async function handleLogin(event) {
      event.preventDefault();
      loginError.classList.add('hidden');
      const formData = new FormData(loginForm);
      const payload = {
        username: formData.get('username'),
        password: formData.get('password'),
      };

      try {
        const response = await fetch('/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.message || TEXT.authError);
        }

        setAuthState(data.username, data.token);
      } catch (error) {
        loginError.textContent = error.message || TEXT.authError;
        loginError.classList.remove('hidden');
      }
    }

    async function createMeeting() {
      const token = sessionStorage.getItem('authToken');
      if (!token) {
        loginError.textContent = TEXT.sessionExpired;
        loginError.classList.remove('hidden');
        setAuthState();
        return;
      }

      createMeetingBtn.disabled = true;
      createMeetingBtn.textContent = TEXT.creating;
      meetingMessage.textContent = '';

      try {
        const response = await fetch('/api/meetings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({}),
        });

        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.message || TEXT.meetingError);
        }

        meetingLinkInput.value = data.meetingUrl;
        meetingBlock.classList.remove('hidden');
        meetingMessage.textContent = TEXT.linkReady;
        openMeetingBtn.dataset.roomToken = data.token;
      } catch (error) {
        meetingMessage.textContent = error.message || TEXT.meetingError;
        meetingBlock.classList.remove('hidden');
      } finally {
        createMeetingBtn.disabled = false;
        createMeetingBtn.textContent = TEXT.create;
      }
    }

    function copyMeetingLink() {
      const link = meetingLinkInput.value;
      if (!link) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(link)
          .then(() => {
            meetingMessage.textContent = TEXT.linkCopied;
          })
          .catch(() => {
            meetingMessage.textContent = TEXT.linkCopyError;
          });
      } else {
        meetingMessage.textContent = TEXT.linkCopyError;
      }
    }

    function openMeeting() {
      const token = openMeetingBtn.dataset.roomToken;
      if (!token) return;
      window.location.href = `/chat.html?room=${encodeURIComponent(token)}`;
    }

    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', () => {
      setAuthState();
    });
    createMeetingBtn.addEventListener('click', createMeeting);
    copyMeetingBtn.addEventListener('click', copyMeetingLink);
    openMeetingBtn.addEventListener('click', openMeeting);

    (function bootstrap() {
      const token = sessionStorage.getItem('authToken');
      const username = sessionStorage.getItem('username');
      if (token && username) {
        showDashboard();
      }
    })();
  </script>
</body>
</html>

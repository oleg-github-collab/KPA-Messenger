<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
  <title>Kaminskyi AI Messenger</title>
  <link rel="stylesheet" href="mobile.css">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kaminskyi AI Messenger">
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%234f46e5'/><text x='50' y='60' text-anchor='middle' font-size='40' font-family='Arial' fill='white'>KAM</text></svg>">
  <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Kaminskyi AI Messenger&quot;,&quot;short_name&quot;:&quot;KAM&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;orientation&quot;:&quot;portrait&quot;,&quot;theme_color&quot;:&quot;%23000000&quot;,&quot;background_color&quot;:&quot;%23000000&quot;,&quot;start_url&quot;:&quot;/mobile.html&quot;}">
  <script>
    // Device detection and redirect with room preservation
    function isDesktopDevice() {
      return !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
             && window.innerWidth > 768;
    }

    if (isDesktopDevice()) {
      // Preserve room parameter when redirecting to desktop
      const urlParams = new URLSearchParams(window.location.search);
      const room = urlParams.get('room');
      const redirectUrl = room ? `/desktop.html?room=${encodeURIComponent(room)}` : '/desktop.html';
      window.location.href = redirectUrl;
    }
  </script>
</head>
<body>
  <div id="nameModal" class="modal hidden">
    <div class="modal-content fade">
      <h2 id="nameModalTitle">Join Video Meeting</h2>
      <p class="muted" id="nameModalText">Enter your name and choose media settings</p>

      <form id="nameForm">
        <div class="form-group">
          <label for="displayNameInput">Your Name</label>
          <input id="displayNameInput" name="displayName" required maxlength="32" placeholder="Enter your name">
        </div>

        <div class="media-settings">
          <h3>Media Settings</h3>
          <div class="media-options">
            <label class="media-option">
              <input type="checkbox" id="enableVideoMobile" checked>
              <span class="checkbox-mark"></span>
              <span class="option-text">Camera</span>
              <span class="option-icon">üìπ</span>
            </label>

            <label class="media-option">
              <input type="checkbox" id="enableAudioMobile" checked>
              <span class="checkbox-mark"></span>
              <span class="option-text">Microphone</span>
              <span class="option-icon">üé§</span>
            </label>
          </div>
        </div>

        <button type="submit" class="primary" id="nameSubmit">Join Meeting</button>
      </form>
      <div id="nameError" class="error hidden"></div>
    </div>
  </div>

  <div class="video-call-container">
    <!-- Back button -->
    <div class="back-button" id="backButton">
      <span class="back-arrow">‚Üê</span>
    </div>

    <!-- Main video area -->
    <div class="main-video" id="mainVideo">
      <div class="active-speaker-view" id="activeSpeakerView">
        <!-- Remote participant video -->
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="video-placeholder remote-placeholder" id="remotePlaceholder">
          <div class="placeholder-avatar">üë§</div>
          <div class="speaker-info">
            <div class="speaker-name" id="speakerName">Waiting for participant...</div>
            <div class="speaker-status">Active Speaker</div>
          </div>
        </div>
      </div>

      <!-- Grid view - 5x2 tiles for group call -->
      <div class="grid-view" id="gridView">
        <div class="grid-tile" data-peer="self">
          <video autoplay playsinline muted></video>
          <div class="grid-avatar">You</div>
          <div class="grid-name">You</div>
          <div class="grid-online"></div>
        </div>
        <!-- Dynamic participant tiles will be added here -->
      </div>
    </div>

    <!-- Small video window (self video) -->
    <div class="small-video" id="smallVideo">
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="video-placeholder local-placeholder" id="localPlaceholder">
        <div class="placeholder-avatar">üë§</div>
      </div>
      <div class="small-video-header">
        <span></span>
        <span class="expand-icon" id="expandIcon">‚Üó</span>
      </div>
    </div>

    <!-- Call timer - CENTERED AT TOP -->
    <div class="call-timer" id="callTimer">
      <span class="timer-dot"></span>
      <span class="timer-value" id="timerValue">00:00</span>
    </div>

    <!-- User name display - appears under timer, fades after 5s -->
    <div class="user-name-display" id="userNameDisplay">
      <span id="displayedUserName">Your Name</span>
    </div>

    <!-- TikTok-style floating chat messages -->
    <div class="floating-messages" id="floatingMessages"></div>

    <!-- Mobile chat overlay - Enhanced -->
    <div class="mobile-chat-overlay" id="mobileChatOverlay">
      <div class="mobile-chat-header">
        <h3>üí¨ Chat</h3>
        <button id="closeChatBtn" class="close-btn">√ó</button>
      </div>
      <div class="mobile-chat-content">
        <div class="mobile-chat-messages" id="mobileChatMessages">
          <div class="chat-welcome">
            <div class="welcome-icon">üí¨</div>
            <p>Start chatting with other participants</p>
          </div>
        </div>
        <div class="mobile-chat-input-area">
          <div class="reply-preview" id="replyPreview" style="display: none;">
            <div class="reply-header">
              <span class="reply-to">Replying to <strong id="replyToName"></strong></span>
              <button class="reply-cancel" id="replyCancel">√ó</button>
            </div>
            <div class="reply-message" id="replyMessage"></div>
          </div>
          <div class="mobile-chat-input-group">
            <input type="text" class="mobile-chat-input" id="mobileChatInput" placeholder="Type a message...">
            <button class="mobile-chat-send" id="mobileChatSend">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom controls - 4 ESSENTIAL BUTTONS -->
    <div class="bottom-controls" id="bottomControls">
      <div class="bottom-btn" id="videoToggleBtn" title="Toggle camera">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M23 7l-7 5 7 5V7z" stroke="currentColor" stroke-width="2"/>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="bottom-btn" id="audioToggleBtn" title="Toggle microphone">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke="currentColor" stroke-width="2"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="currentColor" stroke-width="2"/>
          <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2"/>
          <line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="bottom-btn" id="chatButton" title="Chat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="bottom-btn end-call" id="leaveBtn" title="End call">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
          <path d="M5 12h14m-7-7l7 7-7 7" stroke="currentColor" stroke-width="2" transform="rotate(135 12 12)"/>
        </svg>
      </div>
    </div>

    <!-- Notification banner -->
    <div id="videoNotice" class="notification-banner hidden"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="mobile.js" defer></script>
</body>
</html>